<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VPP Security Gateway - Control Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
        }

        .layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            padding: 0;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
        }

        .logo {
            padding: 25px 20px;
            font-size: 20px;
            font-weight: 700;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.2);
        }

        .logo-icon {
            display: inline-block;
            width: 32px;
            height: 32px;
            background: #3b82f6;
            border-radius: 6px;
            margin-right: 10px;
            vertical-align: middle;
            text-align: center;
            line-height: 32px;
            font-size: 18px;
        }

        .nav-menu {
            padding: 15px 0;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: rgba(255,255,255,0.8);
            font-size: 14px;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-item.active {
            background: rgba(255,255,255,0.15);
            color: white;
            border-left: 3px solid #60a5fa;
            font-weight: 600;
        }

        .nav-icon {
            font-size: 18px;
        }

        /* Main Content */
        .main-content {
            padding: 0;
            overflow-y: auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
            color: #1e3a8a;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .content-area {
            padding: 30px;
        }

        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-card-value {
            font-size: 32px;
            font-weight: 700;
            color: #1e3a8a;
            margin-bottom: 5px;
        }

        .stat-card-label {
            font-size: 14px;
            color: #6b7280;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f3f4f6;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e3a8a;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            background: #f9fafb;
        }

        th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #f3f4f6;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        /* Buttons */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        /* Status Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
            font-size: 14px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1e3a8a;
        }

        /* Tab Content Visibility */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        /* Alert Messages */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        /* Rule Item */
        .rule-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e5e7eb;
        }

        /* Colors */
        .text-primary { color: #3b82f6; }
        .text-success { color: #10b981; }
        .text-danger { color: #ef4444; }
        .bg-blue { background: #dbeafe; }
        .bg-green { background: #d1fae5; }
        .bg-red { background: #fee2e2; }
        .bg-yellow { background: #fef3c7; }
    </style>
</head>
<body>
    <div class="layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <span class="logo-icon">üõ°Ô∏è</span>
                VPP Gateway
            </div>
            <nav class="nav-menu">
                <div class="nav-item active" onclick="switchTab('dashboard')">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="switchTab('interfaces')">
                    <span class="nav-icon">üîå</span>
                    <span>Interfaces</span>
                </div>
                <div class="nav-item" onclick="switchTab('routing')">
                    <span class="nav-icon">üîÄ</span>
                    <span>Routing</span>
                </div>
                <div class="nav-item" onclick="switchTab('acl')">
                    <span class="nav-icon">üîí</span>
                    <span>Firewall Rules</span>
                </div>
                <div class="nav-item" onclick="switchTab('nat')">
                    <span class="nav-icon">üîÑ</span>
                    <span>NAT / PAT</span>
                </div>
                <div class="nav-item" onclick="switchTab('traffic')">
                    <span class="nav-icon">üìà</span>
                    <span>Traffic Monitor</span>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="header">
                    <h1 class="header-title">Dashboard</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="loadDashboard()">‚Üª Refresh</button>
                    </div>
                </div>
                <div class="content-area">
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div class="stat-card-icon bg-blue">üîå</div>
                            </div>
                            <div class="stat-card-value" id="dash-interfaces">-</div>
                            <div class="stat-card-label">Active Interfaces</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div class="stat-card-icon bg-green">üîÄ</div>
                            </div>
                            <div class="stat-card-value" id="dash-routes">-</div>
                            <div class="stat-card-label">Static Routes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div class="stat-card-icon bg-red">üîí</div>
                            </div>
                            <div class="stat-card-value" id="dash-acls">-</div>
                            <div class="stat-card-label">Firewall Rules</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div class="stat-card-icon bg-yellow">üîÑ</div>
                            </div>
                            <div class="stat-card-value" id="dash-nat">-</div>
                            <div class="stat-card-label">NAT Sessions</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Network Traffic Overview</h2>
                        </div>
                        <div class="chart-container">
                            <canvas id="dashboardChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Interfaces Tab -->
            <div id="interfaces" class="tab-content">
                <div class="header">
                    <h1 class="header-title">Network Interfaces</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="loadInterfaces()">‚Üª Refresh</button>
                    </div>
                </div>
                <div class="content-area">
                    <div id="alert-interfaces"></div>
                    <div class="card">
                        <table>
                            <thead>
                                <tr>
                                    <th>Index</th>
                                    <th>Interface Name</th>
                                    <th>Status</th>
                                    <th>MTU</th>
                                    <th>IP Addresses</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="interfaces-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Routing Tab -->
            <div id="routing" class="tab-content">
                <div class="header">
                    <h1 class="header-title">IP Routing Table</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="openAddRouteModal()">+ Add Route</button>
                        <button class="btn btn-secondary" onclick="loadRoutes()">‚Üª Refresh</button>
                    </div>
                </div>
                <div class="content-area">
                    <div id="alert-routing"></div>
                    <div class="card">
                        <table>
                            <thead>
                                <tr>
                                    <th>Destination Network</th>
                                    <th>Next Hop</th>
                                    <th>Interface</th>
                                    <th>Metric</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="routes-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ACL/Firewall Tab -->
            <div id="acl" class="tab-content">
                <div class="header">
                    <h1 class="header-title">Firewall Rules (ACLs)</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="openAddAclModal()">+ Create ACL</button>
                        <button class="btn btn-secondary" onclick="loadAcls()">‚Üª Refresh</button>
                    </div>
                </div>
                <div class="content-area">
                    <div id="alert-acl"></div>
                    <div id="acl-list"></div>
                </div>
            </div>

            <!-- NAT Tab -->
            <div id="nat" class="tab-content">
                <div class="header">
                    <h1 class="header-title">NAT / PAT Configuration</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="openNatAddressModal()">+ Add NAT Pool</button>
                        <button class="btn btn-secondary" onclick="loadNat()">‚Üª Refresh</button>
                    </div>
                </div>
                <div class="content-area">
                    <div id="alert-nat"></div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">NAT Interfaces</h2>
                            <button class="btn btn-primary" onclick="openNatInterfaceModal()">Configure Interface</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Interface Index</th>
                                    <th>Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="nat-interfaces-table"></tbody>
                        </table>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">NAT Address Pool</h2>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Public IP Address</th>
                                    <th>VRF ID</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="nat-addresses-table"></tbody>
                        </table>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Active NAT Sessions</h2>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Inside IP:Port</th>
                                    <th>Outside IP:Port</th>
                                    <th>Protocol</th>
                                </tr>
                            </thead>
                            <tbody id="nat-sessions-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Traffic Monitor Tab -->
            <div id="traffic" class="tab-content">
                <div class="header">
                    <h1 class="header-title">Real-Time Traffic Monitor</h1>
                </div>
                <div class="content-area">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Interface Traffic</h2>
                            <div>
                                <label class="form-label">Select Interface:</label>
                                <select id="ifaceSelect" class="form-select" style="width:250px" onchange="selectInterface()"></select>
                            </div>
                        </div>
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="trafficChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add IP Modal -->
    <div id="ip-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Add IP Address</div>
            <div class="form-group">
                <label class="form-label">IP Address</label>
                <input type="text" id="ip-address" class="form-input" placeholder="192.168.1.1">
            </div>
            <div class="form-group">
                <label class="form-label">Prefix Length</label>
                <input type="number" id="ip-prefix" class="form-input" value="24" min="1" max="32">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="addIpAddress()">Add IP</button>
                <button class="btn btn-secondary" onclick="closeModal('ip-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add Route Modal -->
    <div id="route-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Add Static Route</div>
            <div class="form-group">
                <label class="form-label">Destination Network</label>
                <input type="text" id="route-dest" class="form-input" placeholder="192.168.2.0">
            </div>
            <div class="form-group">
                <label class="form-label">Prefix Length</label>
                <input type="number" id="route-prefix" class="form-input" value="24" min="0" max="32">
            </div>
            <div class="form-group">
                <label class="form-label">Interface</label>
                <select id="route-interface" class="form-select"></select>
            </div>
            <div class="form-group">
                <label class="form-label">Next Hop (optional)</label>
                <input type="text" id="route-nexthop" class="form-input" placeholder="0.0.0.0" value="0.0.0.0">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="addRoute()">Add Route</button>
                <button class="btn btn-secondary" onclick="closeModal('route-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add ACL Modal -->
    <div id="acl-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Create Firewall Rule (ACL)</div>
            <div class="form-group">
                <label class="form-label">ACL Name/Tag</label>
                <input type="text" id="acl-tag" class="form-input" placeholder="my-firewall-rule">
            </div>
            <div class="form-group">
                <label class="form-label">Rules</label>
                <div id="acl-rules-container"></div>
                <button class="btn btn-primary" onclick="addAclRule()">+ Add Rule</button>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="createAcl()">Create ACL</button>
                <button class="btn btn-secondary" onclick="closeModal('acl-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- NAT Address Modal -->
    <div id="nat-address-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Add NAT Pool Address</div>
            <div class="form-group">
                <label class="form-label">Public IP Address</label>
                <input type="text" id="nat-ip" class="form-input" placeholder="203.0.113.1">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="addNatAddress()">Add Address</button>
                <button class="btn btn-secondary" onclick="closeModal('nat-address-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- NAT Interface Modal -->
    <div id="nat-interface-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Configure NAT Interface</div>
            <div class="form-group">
                <label class="form-label">Interface</label>
                <select id="nat-if-index" class="form-select"></select>
            </div>
            <div class="form-group">
                <label class="form-label">Type</label>
                <select id="nat-if-type" class="form-select">
                    <option value="true">Inside (LAN)</option>
                    <option value="false">Outside (WAN)</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="configureNatInterface()">Configure</button>
                <button class="btn btn-secondary" onclick="closeModal('nat-interface-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let currentInterfaces = [];
        let selectedInterface = null;
        let trafficChart, dashboardChart;
        let lastStats = {};
        let trafficData = { labels: [], rx: [], tx: [] };
        let aclRuleCount = 0;

        // Tab Management
        function switchTab(tabName) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            // Load data for specific tabs
            if (tabName === 'dashboard') loadDashboard();
            if (tabName === 'interfaces') loadInterfaces();
            if (tabName === 'routing') loadRoutes();
            if (tabName === 'acl') loadAcls();
            if (tabName === 'nat') loadNat();
        }

        // Alert Management
        function showAlert(containerId, message, type = 'success') {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 4000);
        }

        // Modal Management
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ========== DASHBOARD ==========
        async function loadDashboard() {
            try {
                const res = await fetch(`${API_BASE}/dashboard/stats`);
                const data = await res.json();
                
                document.getElementById('dash-interfaces').textContent = 
                    `${data.interfaces.active}/${data.interfaces.total}`;
                document.getElementById('dash-routes').textContent = data.routes;
                document.getElementById('dash-acls').textContent = data.acls;
                document.getElementById('dash-nat').textContent = data.nat_sessions;
            } catch (err) {
                console.error('Failed to load dashboard:', err);
            }
        }

        function initDashboardChart() {
            const ctx = document.getElementById('dashboardChart');
            if (!ctx) return;
            
            dashboardChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Total RX (Mbps)',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Total TX (Mbps)',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // ========== INTERFACES ==========
        async function loadInterfaces() {
            try {
                const res = await fetch(`${API_BASE}/interfaces`);
                const data = await res.json();
                currentInterfaces = data;

                const tbody = document.getElementById('interfaces-table');
                tbody.innerHTML = data.map(iface => `
                    <tr>
                        <td>${iface.sw_if_index}</td>
                        <td><strong>${iface.name}</strong></td>
                        <td><span class="badge badge-${iface.status === 'up' ? 'success' : 'danger'}">${iface.status.toUpperCase()}</span></td>
                        <td>${iface.mtu}</td>
                        <td>${iface.ip_addresses.join(', ') || '<em>No IP</em>'}</td>
                        <td>
                            <button class="btn ${iface.status === 'up' ? 'btn-danger' : 'btn-success'}" 
                                onclick="toggleInterface(${iface.sw_if_index}, '${iface.status}')">
                                ${iface.status === 'up' ? 'Disable' : 'Enable'}
                            </button>
                            <button class="btn btn-primary" onclick="openIpModal(${iface.sw_if_index})">+ IP</button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                showAlert('alert-interfaces', 'Failed to load interfaces: ' + err.message, 'error');
            }
        }

        async function toggleInterface(sw_if_index, currentStatus) {
            try {
                const res = await fetch(`${API_BASE}/interface/${sw_if_index}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ up: currentStatus !== 'up' })
                });
                const data = await res.json();
                showAlert('alert-interfaces', `Interface ${data.status === 'up' ? 'enabled' : 'disabled'}`);
                loadInterfaces();
            } catch (err) {
                showAlert('alert-interfaces', 'Failed to toggle interface: ' + err.message, 'error');
            }
        }

        function openIpModal(sw_if_index) {
            selectedInterface = sw_if_index;
            document.getElementById('ip-modal').classList.add('active');
        }

        async function addIpAddress() {
            const ip = document.getElementById('ip-address').value;
            const prefix = document.getElementById('ip-prefix').value;

            try {
                const res = await fetch(`${API_BASE}/interface/${selectedInterface}/ip`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip, prefix_len: prefix })
                });
                await res.json();
                showAlert('alert-interfaces', 'IP address added successfully');
                closeModal('ip-modal');
                loadInterfaces();
            } catch (err) {
                showAlert('alert-interfaces', 'Failed to add IP: ' + err.message, 'error');
            }
        }

        // ========== ROUTING ==========
        async function loadRoutes() {
            try {
                const res = await fetch(`${API_BASE}/routes`);
                const data = await res.json();

                const tbody = document.getElementById('routes-table');
                tbody.innerHTML = data.map(route => `
                    <tr>
                        <td><strong>${route.destination}</strong></td>
                        <td>${route.next_hop}</td>
                        <td>${route.interface_name}</td>
                        <td>${route.weight}</td>
                        <td>
                            <button class="btn btn-danger" 
                                onclick="deleteRoute('${route.destination}', ${route.sw_if_index}, '${route.next_hop}')">
                                Delete
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                showAlert('alert-routing', 'Failed to load routes: ' + err.message, 'error');
            }
        }

        function openAddRouteModal() {
            const select = document.getElementById('route-interface');
            select.innerHTML = currentInterfaces.map(iface =>
                `<option value="${iface.sw_if_index}">${iface.name} (${iface.sw_if_index})</option>`
            ).join('');
            document.getElementById('route-modal').classList.add('active');
        }

        async function addRoute() {
            const dest = document.getElementById('route-dest').value;
            const prefix = document.getElementById('route-prefix').value;
            const ifIndex = document.getElementById('route-interface').value;
            const nextHop = document.getElementById('route-nexthop').value;

            try {
                await fetch(`${API_BASE}/route`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        destination: dest,
                        prefix_len: prefix,
                        sw_if_index: ifIndex,
                        next_hop: nextHop
                    })
                });
                showAlert('alert-routing', 'Route added successfully');
                closeModal('route-modal');
                loadRoutes();
            } catch (err) {
                showAlert('alert-routing', 'Failed to add route: ' + err.message, 'error');
            }
        }

        async function deleteRoute(dest, ifIndex, nextHop) {
            if (!confirm('Delete this route?')) return;

            const [ip, prefix] = dest.split('/');
            try {
                await fetch(`${API_BASE}/route`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        destination: ip,
                        prefix_len: prefix,
                        sw_if_index: ifIndex,
                        next_hop: nextHop === 'direct' ? '0.0.0.0' : nextHop
                    })
                });
                showAlert('alert-routing', 'Route deleted successfully');
                loadRoutes();
            } catch (err) {
                showAlert('alert-routing', 'Failed to delete route: ' + err.message, 'error');
            }
        }

        // ========== ACL/FIREWALL ==========
        function openAddAclModal() {
            document.getElementById('acl-rules-container').innerHTML = '';
            aclRuleCount = 0;
            addAclRule();
            document.getElementById('acl-modal').classList.add('active');
        }

        function addAclRule() {
            const container = document.getElementById('acl-rules-container');
            const ruleId = aclRuleCount++;
            const ruleHtml = `
                <div class="rule-item" id="rule-${ruleId}">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Action</label>
                            <select id="action-${ruleId}" class="form-select">
                                <option value="permit">Permit</option>
                                <option value="deny">Deny</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Protocol</label>
                            <select id="proto-${ruleId}" class="form-select">
                                <option value="0">Any</option>
                                <option value="1">ICMP</option>
                                <option value="6">TCP</option>
                                <option value="17">UDP</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Source IP/Prefix</label>
                            <input type="text" id="src-ip-${ruleId}" class="form-input" placeholder="0.0.0.0/0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Destination IP/Prefix</label>
                            <input type="text" id="dst-ip-${ruleId}" class="form-input" placeholder="0.0.0.0/0">
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Source Port Range</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="src-port-min-${ruleId}" class="form-input" placeholder="0" min="0" max="65535">
                                <input type="number" id="src-port-max-${ruleId}" class="form-input" placeholder="65535" min="0" max="65535">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Destination Port Range</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="dst-port-min-${ruleId}" class="form-input" placeholder="0" min="0" max="65535">
                                <input type="number" id="dst-port-max-${ruleId}" class="form-input" placeholder="65535" min="0" max="65535">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="document.getElementById('rule-${ruleId}').remove()">Remove Rule</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', ruleHtml);
        }

        async function createAcl() {
            const tag = document.getElementById('acl-tag').value.trim();
            if (!tag) {
                showAlert('alert-acl', 'Please enter an ACL tag/name', 'error');
                return;
            }

            const rules = [];
            for (let i = 0; i < aclRuleCount; i++) {
                const ruleEl = document.getElementById(`rule-${i}`);
                if (!ruleEl) continue;

                const srcIpFull = document.getElementById(`src-ip-${i}`).value || '0.0.0.0/0';
                const dstIpFull = document.getElementById(`dst-ip-${i}`).value || '0.0.0.0/0';
                const [srcIp, srcPrefix] = srcIpFull.split('/');
                const [dstIp, dstPrefix] = dstIpFull.split('/');

                rules.push({
                    action: document.getElementById(`action-${i}`).value,
                    proto: parseInt(document.getElementById(`proto-${i}`).value),
                    src_ip: srcIp,
                    src_prefix_len: parseInt(srcPrefix || 0),
                    dst_ip: dstIp,
                    dst_prefix_len: parseInt(dstPrefix || 0),
                    src_port_min: parseInt(document.getElementById(`src-port-min-${i}`).value || 0),
                    src_port_max: parseInt(document.getElementById(`src-port-max-${i}`).value || 65535),
                    dst_port_min: parseInt(document.getElementById(`dst-port-min-${i}`).value || 0),
                    dst_port_max: parseInt(document.getElementById(`dst-port-max-${i}`).value || 65535)
                });
            }

            // Add default permit rule
            rules.push({
                action: 'permit',
                proto: 0,
                src_ip: '0.0.0.0',
                src_prefix_len: 0,
                dst_ip: '0.0.0.0',
                dst_prefix_len: 0,
                src_port_min: 0,
                src_port_max: 65535,
                dst_port_min: 0,
                dst_port_max: 65535
            });

            try {
                const res = await fetch(`${API_BASE}/acl`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tag, rules })
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                showAlert('alert-acl', `ACL "${tag}" created successfully (index ${data.acl_index})`);
                closeModal('acl-modal');
                loadAcls();
            } catch (err) {
                showAlert('alert-acl', 'Failed to create ACL: ' + err.message, 'error');
            }
        }

        async function loadAcls() {
            try {
                const res = await fetch(`${API_BASE}/acls`);
                const data = await res.json();

                const container = document.getElementById('acl-list');
                container.innerHTML = data.map(acl => `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ACL ${acl.acl_index}: ${acl.tag}</h3>
                            <span class="badge badge-info">${acl.count} rule(s)</span>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Action</th>
                                    <th>Protocol</th>
                                    <th>Source</th>
                                    <th>Destination</th>
                                    <th>Ports</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${acl.rules.map(rule => `
                                    <tr>
                                        <td><span class="badge badge-${rule.is_permit ? 'success' : 'danger'}">
                                            ${rule.is_permit ? 'PERMIT' : 'DENY'}
                                        </span></td>
                                        <td>${rule.proto === 0 ? 'ANY' : rule.proto === 1 ? 'ICMP' : rule.proto === 6 ? 'TCP' : rule.proto === 17 ? 'UDP' : rule.proto}</td>
                                        <td>${rule.src_prefix}</td>
                                        <td>${rule.dst_prefix}</td>
                                        <td>${rule.src_port_min}-${rule.src_port_max} ‚Üí ${rule.dst_port_min}-${rule.dst_port_max}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px;">
                            <select id="iface-select-${acl.acl_index}" class="form-select" style="width: 200px;">
                                ${currentInterfaces.map(i => `<option value="${i.sw_if_index}">${i.name}</option>`).join('')}
                            </select>
                            <select id="direction-${acl.acl_index}" class="form-select" style="width: 150px;">
                                <option value="true">Input</option>
                                <option value="false">Output</option>
                            </select>
                            <button class="btn btn-success" onclick="applyAcl(${acl.acl_index}, true)">Apply to Interface</button>
                            <button class="btn btn-danger" onclick="applyAcl(${acl.acl_index}, false)">Remove from Interface</button>
                            <button class="btn btn-danger" onclick="deleteAcl(${acl.acl_index})" style="margin-left: auto;">Delete ACL</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                showAlert('alert-acl', 'Failed to load ACLs: ' + err.message, 'error');
            }
        }

        async function deleteAcl(aclIndex) {
            if (!confirm('Delete this ACL?')) return;

            try {
                await fetch(`${API_BASE}/acl/${aclIndex}`, { method: 'DELETE' });
                showAlert('alert-acl', 'ACL deleted successfully');
                loadAcls();
            } catch (err) {
                showAlert('alert-acl', 'Failed to delete ACL: ' + err.message, 'error');
            }
        }

        async function applyAcl(aclIndex, isApply) {
            const sw_if_index = parseInt(document.getElementById(`iface-select-${aclIndex}`).value);
            const is_input = document.getElementById(`direction-${aclIndex}`).value === "true";

            try {
                await fetch(`${API_BASE}/acl/${aclIndex}/interface/${sw_if_index}`, {
                    method: isApply ? 'POST' : 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_input })
                });

                showAlert('alert-acl', `ACL ${isApply ? 'applied to' : 'removed from'} interface ${sw_if_index}`, 'success');
            } catch (err) {
                showAlert('alert-acl', 'Failed to modify ACL: ' + err.message, 'error');
            }
        }

        // ========== NAT ==========
        async function loadNat() {
            await loadNatInterfaces();
            await loadNatAddresses();
            await loadNatSessions();
        }

        async function loadNatInterfaces() {
            try {
                const res = await fetch(`${API_BASE}/nat/interfaces`);
                const data = await res.json();

                const tbody = document.getElementById('nat-interfaces-table');
                tbody.innerHTML = data.map(natIf => `
                    <tr>
                        <td>${natIf.sw_if_index}</td>
                        <td><span class="badge badge-${natIf.is_inside ? 'success' : 'info'}">
                            ${natIf.is_inside ? 'Inside (LAN)' : 'Outside (WAN)'}
                        </span></td>
                        <td>
                            <button class="btn btn-danger" onclick="removeNatInterface(${natIf.sw_if_index}, ${natIf.is_inside})">
                                Remove
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('Failed to load NAT interfaces:', err);
            }
        }

        async function loadNatAddresses() {
            try {
                const res = await fetch(`${API_BASE}/nat/addresses`);
                const data = await res.json();

                const tbody = document.getElementById('nat-addresses-table');
                tbody.innerHTML = data.map(addr => `
                    <tr>
                        <td><strong>${addr.ip_address}</strong></td>
                        <td>${addr.vrf_id}</td>
                        <td>
                            <button class="btn btn-danger" onclick="removeNatAddress('${addr.ip_address}')">
                                Remove
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('Failed to load NAT addresses:', err);
            }
        }

        async function loadNatSessions() {
            try {
                const res = await fetch(`${API_BASE}/nat/sessions`);
                const data = await res.json();

                const tbody = document.getElementById('nat-sessions-table');
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;"><em>No active sessions</em></td></tr>';
                } else {
                    tbody.innerHTML = data.map(session => `
                        <tr>
                            <td>${session.inside_ip}:${session.inside_port}</td>
                            <td>${session.outside_ip}:${session.outside_port}</td>
                            <td>${session.protocol === 6 ? 'TCP' : session.protocol === 17 ? 'UDP' : session.protocol}</td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                console.error('Failed to load NAT sessions:', err);
            }
        }

        function openNatAddressModal() {
            document.getElementById('nat-address-modal').classList.add('active');
        }

        async function addNatAddress() {
            const ip = document.getElementById('nat-ip').value;

            try {
                await fetch(`${API_BASE}/nat/address`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip_address: ip })
                });
                showAlert('alert-nat', 'NAT address added successfully');
                closeModal('nat-address-modal');
                loadNatAddresses();
            } catch (err) {
                showAlert('alert-nat', 'Failed to add NAT address: ' + err.message, 'error');
            }
        }

        async function removeNatAddress(ip) {
            if (!confirm('Remove this NAT address?')) return;

            try {
                await fetch(`${API_BASE}/nat/address`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip_address: ip })
                });
                showAlert('alert-nat', 'NAT address removed successfully');
                loadNatAddresses();
            } catch (err) {
                showAlert('alert-nat', 'Failed to remove NAT address: ' + err.message, 'error');
            }
        }

        function openNatInterfaceModal() {
            const select = document.getElementById('nat-if-index');
            select.innerHTML = currentInterfaces.map(iface =>
                `<option value="${iface.sw_if_index}">${iface.name} (${iface.sw_if_index})</option>`
            ).join('');
            document.getElementById('nat-interface-modal').classList.add('active');
        }

        async function configureNatInterface() {
            const sw_if_index = parseInt(document.getElementById('nat-if-index').value);
            const is_inside = document.getElementById('nat-if-type').value === 'true';

            try {
                await fetch(`${API_BASE}/nat/interface/${sw_if_index}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_inside })
                });
                showAlert('alert-nat', 'NAT interface configured successfully');
                closeModal('nat-interface-modal');
                loadNatInterfaces();
            } catch (err) {
                showAlert('alert-nat', 'Failed to configure NAT interface: ' + err.message, 'error');
            }
        }

        async function removeNatInterface(sw_if_index, is_inside) {
            if (!confirm('Remove NAT configuration from this interface?')) return;

            try {
                await fetch(`${API_BASE}/nat/interface/${sw_if_index}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_inside })
                });
                showAlert('alert-nat', 'NAT interface removed successfully');
                loadNatInterfaces();
            } catch (err) {
                showAlert('alert-nat', 'Failed to remove NAT interface: ' + err.message, 'error');
            }
        }

        // ========== TRAFFIC MONITORING ==========
        function initTrafficChart() {
            const ctx = document.getElementById('trafficChart');
            trafficChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trafficData.labels,
                    datasets: [{
                        label: 'RX Mbps',
                        data: trafficData.rx,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'TX Mbps',
                        data: trafficData.tx,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Mbps' }
                        },
                        x: {
                            title: { display: true, text: 'Time' }
                        }
                    }
                }
            });
        }

        async function updateTrafficChart() {
            try {
                const res = await fetch(`${API_BASE}/interfaces/stats`);
                const data = await res.json();

                const now = new Date().toLocaleTimeString();
                trafficData.labels.push(now);
                
                if (trafficData.labels.length > 30) {
                    trafficData.labels.shift();
                    trafficData.rx.shift();
                    trafficData.tx.shift();
                }

                let totalRxRate = 0;
                let totalTxRate = 0;

                data.forEach(iface => {
                    const prev = lastStats[iface.name];
                    if (prev) {
                        const rxRate = (iface.rx_bytes - prev.rx_bytes) * 8 / (2 * 1e6);
                        const txRate = (iface.tx_bytes - prev.tx_bytes) * 8 / (2 * 1e6);
                        totalRxRate += Math.max(0, rxRate);
                        totalTxRate += Math.max(0, txRate);
                    }
                    lastStats[iface.name] = iface;
                });

                trafficData.rx.push(totalRxRate.toFixed(2));
                trafficData.tx.push(totalTxRate.toFixed(2));

                if (trafficChart) {
                    trafficChart.update();
                }
            } catch (err) {
                console.error("Failed to update traffic chart", err);
            }
        }

        function selectInterface() {
            selectedInterface = document.getElementById('ifaceSelect').value;
            trafficData.labels = [];
            trafficData.rx = [];
            trafficData.tx = [];
        }

        async function populateInterfaceSelect() {
            try {
                const res = await fetch(`${API_BASE}/interfaces/stats`);
                const data = await res.json();
                const select = document.getElementById('ifaceSelect');
                select.innerHTML = data.map(i => `<option value="${i.name}">${i.name}</option>`).join('');
                if (!selectedInterface && data.length > 0) {
                    selectedInterface = data[0].name;
                }
            } catch (err) {
                console.error("Failed to load interface list", err);
            }
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
            loadInterfaces();
            initDashboardChart();
            initTrafficChart();
            populateInterfaceSelect();
            
            // Auto-refresh dashboard stats
            setInterval(loadDashboard, 5000);
            
            // Auto-refresh traffic monitor
            setInterval(updateTrafficChart, 2000);
            
            // Auto-refresh NAT sessions
            setInterval(() => {
                if (document.getElementById('nat').classList.contains('active')) {
                    loadNatSessions();
                }
            }, 3000);
        });
    </script>
</body>
</html>